<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Microplastics Analyzer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="mobile-container">
        <!-- Status Bar -->
        <div class="status-bar"></div>
        
        <!-- Header -->
        <div class="header">
            <button class="back-button" onclick="window.location.href='index.html'">‚Üê</button>
            <h1>Analysis History</h1>
            <p>Your scanning patterns and trends</p>
        </div>

        <!-- History Content -->
        <div class="main-content">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showHistoryTab('overview')">Overview</button>
                <button class="nav-tab" onclick="showHistoryTab('trends')">Trends</button>
                <button class="nav-tab" onclick="showHistoryTab('details')">Details</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="history-section active">
                <!-- Chart Container -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Analysis Trends</div>
                        <div class="chart-period" id="chart-period">7 days</div>
                    </div>
                    <div class="real-chart" id="main-chart">
                        <!-- Real trend chart will be rendered here -->
                        <div class="chart-loading">Loading chart data...</div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-analyses">56</div>
                        <div class="stat-label">Total Scans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="this-week">44</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracy">100%</div>
                        <div class="stat-label">Health Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-score">4.1</div>
                        <div class="stat-label">Avg ppm</div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trends" class="history-section">
                <div class="trends-container">
                    <div class="trend-chart-header">
                        <h3>Weekly Scan Distribution</h3>
                        <select id="chart-type" onchange="updateChartType()">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                        </select>
                    </div>
                    <div class="weekly-chart" id="weekly-trend-chart">
                        <!-- Weekly trend chart -->
                    </div>
                    
                    <div class="risk-distribution">
                        <h3>Risk Level Distribution</h3>
                        <div class="risk-bars" id="risk-chart">
                            <!-- Risk distribution chart -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Details Tab -->
            <div id="details" class="history-section">
                <div class="details-container">
                    <div class="search-filter">
                        <input type="text" id="search-input" placeholder="Search analyses..." onkeyup="filterHistory()">
                        <select id="filter-risk" onchange="filterHistory()">
                            <option value="">All Risk Levels</option>
                            <option value="LOW">Low Risk</option>
                            <option value="MEDIUM">Medium Risk</option>
                            <option value="HIGH">High Risk</option>
                        </select>
                    </div>
                    
                    <div class="history-list" id="detailed-history">
                        <!-- Detailed history list will be loaded here -->
                        <div class="history-loading">Loading detailed history...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">

            <div class="nav-item" onclick="window.location.href='scan.html'">
                <div class="nav-icon">üì∑</div>
                <div class="nav-label">Scan</div>
            </div>

            <div class="nav-item" onclick="window.location.href='info.html'">
                <div class="nav-icon">üõà</div>
            </div>
        </div>
    </div>

    <style>
        /* Additional styles for history page */
        .history-section {
            display: none;
            padding: 20px 0;
        }
        
        .history-section.active {
            display: block;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .chart-period {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
        }
        
        .real-chart {
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: end;
            padding: 20px;
            gap: 8px;
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.7);
        }
        
        .chart-day {
            flex: 1;
            background: linear-gradient(135deg, #10b981, #34d399);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            display: flex;
            flex-direction: column;
            justify-content: end;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-day:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .chart-day-label {
            color: white;
            font-size: 10px;
            margin-top: 8px;
            position: absolute;
            bottom: -20px;
        }
        
        .chart-day-value {
            color: white;
            font-size: 10px;
            margin-bottom: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chart-day:hover .chart-day-value {
            opacity: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .weekly-chart {
            height: 180px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: end;
            gap: 12px;
        }
        
        .risk-distribution {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        
        .risk-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .risk-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .risk-label {
            width: 60px;
            font-size: 12px;
            color: white;
        }
        
        .risk-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .risk-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        
        .risk-fill.low { background: #10b981; }
        .risk-fill.medium { background: #f59e0b; }
        .risk-fill.high { background: #ef4444; }
        
        .risk-count {
            color: white;
            font-size: 12px;
            min-width: 30px;
        }
        
        .search-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .search-filter input,
        .search-filter select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item-info {
            flex: 1;
        }
        
        .history-item-title {
            color: white;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .history-item-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }
        
        .history-item-risk {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .trend-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .trend-chart-header h3 {
            color: white;
            margin: 0;
        }
        
        .trend-chart-header select {
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8002';
        let allReports = [];
        let currentChartType = 'bar';

        // API functions
        const API = {
            async getAnalysisStats() {
                try {
                    const response = await fetch(`${API_BASE_URL}/analysis/stats`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to fetch analysis stats:', error);
                    throw error;
                }
            },

            async getReports(limit = 100) {
                try {
                    const response = await fetch(`${API_BASE_URL}/reports?limit=${limit}`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to fetch reports:', error);
                    throw error;
                }
            }
        };

        // Tab navigation
        function showHistoryTab(tabName) {
            document.querySelectorAll('.history-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showHistoryTab('${tabName}')"]`).classList.add('active');
        }

        // Generate daily analysis data for last 7 days
        function generateDailyData(reports) {
            const dailyData = new Array(7).fill(0);
            const today = new Date();
            const dayLabels = [];
            
            // Generate day labels (last 7 days)
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dayLabels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            
            // Count reports per day
            reports.forEach(report => {
                const reportDate = new Date(report.timestamp);
                const daysAgo = Math.floor((today - reportDate) / (1000 * 60 * 60 * 24));
                
                if (daysAgo >= 0 && daysAgo < 7) {
                    dailyData[6 - daysAgo]++;
                }
            });
            
            return { data: dailyData, labels: dayLabels };
        }

        // Render main trend chart
        function renderMainChart(reports) {
            const chartContainer = document.getElementById('main-chart');
            const { data, labels } = generateDailyData(reports);
            const maxValue = Math.max(...data, 1);
            
            chartContainer.innerHTML = '';
            
            data.forEach((count, index) => {
                const height = Math.max((count / maxValue) * 100, 5);
                const day = document.createElement('div');
                day.className = 'chart-day';
                day.style.height = height + '%';
                day.innerHTML = `
                    <div class="chart-day-value">${count}</div>
                    <div class="chart-day-label">${labels[index]}</div>
                `;
                day.title = `${labels[index]}: ${count} scans`;
                chartContainer.appendChild(day);
            });
        }

        // Render weekly trend chart
        function renderWeeklyChart(reports) {
            const chartContainer = document.getElementById('weekly-trend-chart');
            const { data, labels } = generateDailyData(reports);
            const maxValue = Math.max(...data, 1);
            
            chartContainer.innerHTML = '';
            
            if (currentChartType === 'bar') {
                data.forEach((count, index) => {
                    const height = Math.max((count / maxValue) * 100, 5);
                    const bar = document.createElement('div');
                    bar.className = 'chart-day';
                    bar.style.height = height + '%';
                    bar.style.background = `linear-gradient(135deg, #10b981, #34d399)`;
                    bar.innerHTML = `
                        <div class="chart-day-value">${count}</div>
                        <div class="chart-day-label">${labels[index]}</div>
                    `;
                    chartContainer.appendChild(bar);
                });
            } else {
                // Simple line chart representation
                chartContainer.innerHTML = '<div style="color: white; text-align: center; padding: 60px;">Line chart coming soon...</div>';
            }
        }

        // Render risk distribution
        function renderRiskChart(stats) {
            const chartContainer = document.getElementById('risk-chart');
            const riskData = stats.risk_distribution || { low: 0, medium: 0, high: 0 };
            const total = riskData.low + riskData.medium + riskData.high || 1;
            
            const risks = [
                { label: 'Low', count: riskData.low, class: 'low' },
                { label: 'Medium', count: riskData.medium, class: 'medium' },
                { label: 'High', count: riskData.high, class: 'high' }
            ];
            
            chartContainer.innerHTML = '';
            
            risks.forEach(risk => {
                const percentage = Math.round((risk.count / total) * 100);
                const riskBar = document.createElement('div');
                riskBar.className = 'risk-bar';
                riskBar.innerHTML = `
                    <div class="risk-label">${risk.label}</div>
                    <div class="risk-progress">
                        <div class="risk-fill ${risk.class}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="risk-count">${risk.count}</div>
                `;
                chartContainer.appendChild(riskBar);
            });
        }

        // Render detailed history
        function renderDetailedHistory(reports) {
            const container = document.getElementById('detailed-history');
            
            if (reports.length === 0) {
                container.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">No scan history found</div>';
                return;
            }
            
            container.innerHTML = '';
            
            reports.slice(0, 20).forEach(report => {
                const content = report.content;
                const lines = content.split('\n');
                
                let foodType = 'Unknown';
                let riskLevel = 'UNKNOWN';
                let microplastics = '0';
                let calories = '0';
                
                lines.forEach(line => {
                    if (line.startsWith('FOOD:')) {
                        foodType = line.split(':')[1].trim();
                    } else if (line.startsWith('RISK:')) {
                        riskLevel = line.split(':')[1].trim();
                    } else if (line.startsWith('MICROPLASTICS:')) {
                        microplastics = line.split(':')[1].trim();
                    } else if (line.startsWith('CALORIES:')) {
                        calories = line.split(':')[1].trim();
                    }
                });
                
                const date = new Date(report.timestamp);
                const riskClass = riskLevel.toLowerCase();
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <div class="history-item-title">${foodType}</div>
                        <div class="history-item-details">
                            ${date.toLocaleDateString()} ‚Ä¢ ${microplastics} ‚Ä¢ ${calories}
                        </div>
                    </div>
                    <div class="history-item-risk ${riskClass}" style="background: ${getRiskColor(riskLevel)}">${riskLevel}</div>
                `;
                
                container.appendChild(historyItem);
            });
        }

        // Helper functions
        function getRiskColor(risk) {
            switch (risk.toLowerCase()) {
                case 'low': return '#10b981';
                case 'medium': return '#f59e0b';
                case 'high': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffMinutes < 60) return `${diffMinutes} minutes ago`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} hours ago`;
            return `${Math.floor(diffMinutes / 1440)} days ago`;
        }

        function updateChartType() {
            currentChartType = document.getElementById('chart-type').value;
            renderWeeklyChart(allReports);
        }

        function filterHistory() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const riskFilter = document.getElementById('filter-risk').value;
            
            let filteredReports = allReports;
            
            if (searchTerm) {
                filteredReports = filteredReports.filter(report => {
                    return report.content.toLowerCase().includes(searchTerm);
                });
            }
            
            if (riskFilter) {
                filteredReports = filteredReports.filter(report => {
                    return report.content.includes(`RISK: ${riskFilter}`);
                });
            }
            
            renderDetailedHistory(filteredReports);
        }

        // Load all data
        async function loadHistoryData() {
            try {
                console.log('Loading history data...');
                
                // Load analysis stats
                const statsResponse = await API.getAnalysisStats();
                if (statsResponse.success) {
                    const stats = statsResponse.stats;
                    
                    // Update overview stats
                    document.getElementById('total-analyses').textContent = stats.total_analyses || 0;
                    document.getElementById('this-week').textContent = stats.recent_analyses || 0;
                    document.getElementById('accuracy').textContent = Math.round(((stats.risk_distribution?.low || 0) / Math.max(stats.total_analyses, 1)) * 100) + '%';
                    document.getElementById('avg-score').textContent = (stats.average_microplastics || 0).toFixed(1);
                    
                    // Render risk chart
                    renderRiskChart(stats);
                }
                
                // Load reports
                const reportsResponse = await API.getReports(100);
                if (reportsResponse.success) {
                    allReports = reportsResponse.reports || [];
                    
                    // Render all charts
                    renderMainChart(allReports);
                    renderWeeklyChart(allReports);
                    renderDetailedHistory(allReports);
                }
                
                console.log('History data loaded successfully');
                
            } catch (error) {
                console.error('Failed to load history data:', error);
                
                // Show error message
                document.getElementById('main-chart').innerHTML = '<div style="color: white; text-align: center;">Failed to load data</div>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('History page initialized');
            loadHistoryData();
        });
    </script>
</body>
</html>